let c=0,i=[],l="ASMR";chrome.storage.local.get(["downloadQueue","downloadRoot"],e=>{e.downloadQueue&&(i=e.downloadQueue,i.forEach(t=>{t.status==="downloading"&&(t.status="pending",t.files.forEach(r=>{r.status==="downloading"&&(r.status="pending")}))}),a()),e.downloadRoot!==void 0&&(l=e.downloadRoot)});function a(){chrome.storage.local.set({downloadQueue:i,downloadRoot:l}),E()}function E(){console.log("Broadcasting Queue Update",i.length),chrome.runtime.sendMessage({type:"QUEUE_UPDATE",queue:i}).catch(()=>{}),chrome.tabs.query({url:["*://asmr.one/*","*://www.asmr.one/*"]},e=>{e.forEach(t=>{chrome.tabs.sendMessage(t.id,{type:"QUEUE_UPDATE",queue:i}).catch(r=>{console.log(`Failed to send to tab ${t.id}:`,r)})})})}chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="ADD_TO_QUEUE")y(e.rjCode,e.files).then(()=>r({queue:i}));else if(e.type==="PAUSE_ITEM")p(e.rjCode,"paused"),r({queue:i});else if(e.type==="RESUME_ITEM")p(e.rjCode,"pending"),u(),r({queue:i});else if(e.type==="CANCEL_ITEM")T(e.rjCode),r({queue:i});else if(e.type==="CLEAR_COMPLETED")g(),r({queue:i});else if(e.type==="RETRY_ITEM")m(e.rjCode),r({queue:i});else if(e.type==="GET_TRACKS")D(e.rjCode).then(o=>r(o));else if(e.type==="GET_QUEUE")r({queue:i,root:l});else if(e.type==="UPDATE_SETTINGS"){let o=e.root||"";o=o.replace(/\\/g,"/"),o=o.replace(/[<>:"|?*]/g,""),o=o.replace(/\.\./g,""),o=o.split("/").filter(n=>n.trim().length>0).join("/"),l=o,a(),r({success:!0,root:l})}return!0});function m(e){const t=i.find(r=>r.rjCode===e);t&&(t.status="pending",t.files.forEach(r=>{r.status==="error"&&(r.status="pending")}),a(),u())}function g(){i=i.filter(e=>e.status!=="completed"),a()}async function D(e){const t=parseInt(e.replace("RJ",""),10);if(isNaN(t))return{error:"Invalid Code"};try{return{data:await h(t)}}catch(r){return{error:r.message}}}async function y(e,t=null){if(i.find(n=>n.rjCode===e))return;const r=parseInt(e.replace("RJ",""),10);if(isNaN(r)){console.error("Invalid RJ Code:",e);return}const o={rjCode:e,status:"fetching_info",progress:0,totalFiles:0,completedFiles:0,files:[]};i.push(o),a();try{if(t)o.files=t.map(n=>({...n,status:"pending"}));else{const n=await h(r);o.files=C(n,e)}o.totalFiles=o.files.length,o.status="pending",a(),u()}catch(n){console.error("Failed to fetch info",n),o.status="error",a()}}function h(e){return fetch(`https://api.asmr-200.com/api/tracks/${e}`).then(t=>{if(!t.ok)throw new Error("API Error");return t.json()})}function C(e,t){let r=[];function o(n,s){if(n.type==="folder"){const d=s?`${s}/${n.title}`:n.title;n.children&&n.children.forEach(w=>o(w,d))}else n.mediaDownloadUrl&&r.push({url:n.mediaDownloadUrl,path:`${t}/${s}/${n.title}`,status:"pending"})}return e.forEach(n=>o(n,"")),r}function p(e,t){const r=i.find(o=>o.rjCode===e);r&&(r.status=t,a())}function T(e){i=i.filter(t=>t.rjCode!==e),a()}async function u(){if(!(c>=3)){for(const e of i)if(e.status==="pending"||e.status==="downloading"){e.status==="pending"&&(e.status="downloading",a());for(const t of e.files)if(t.status==="pending"){if(c>=3)return;I(e,t)}}}}function I(e,t){c++,t.status="downloading",a(),chrome.downloads.download({url:t.url,filename:l?`${l}/${t.path}`:t.path,conflictAction:"overwrite",saveAs:!1},r=>{chrome.runtime.lastError?(console.error("Download failed to start",chrome.runtime.lastError),t.status="error",c--,a(),u()):t.downloadId=r})}chrome.downloads.onChanged.addListener(async e=>{console.log("Download Event:",e);let t=!1;for(const r of i)if(r.files.find(o=>o.downloadId===e.id)){t=!0;break}t?e.state&&e.state.current==="complete"?f(e.id,!0):e.state&&e.state.current==="interrupted"&&f(e.id,!1):e.state&&U(e.id)});async function U(e){try{const[t]=await chrome.downloads.search({id:e});if(!t||!t.url)return;for(const r of i){const o=r.files.find(n=>n.url===t.url&&n.status!=="completed");if(o){console.log(`[Recovery] Found orphaned download ${e} matching file ${o.path}`),o.downloadId=e,o.status="downloading",t.state==="complete"?(o.status="completed",r.completedFiles++):t.state==="interrupted"&&(o.status="error"),a(),t.state==="complete"&&f(e,!0);break}}}catch(t){console.error("Recovery failed",t)}}function f(e,t){console.log(`Checking completion for ID: ${e}, Success: ${t}`);let r=!1;for(const o of i){const n=o.files.find(s=>s.downloadId===e);if(n){console.log(`Found file: ${n.path}`),c--,n.status=t?"completed":"error",t&&o.completedFiles++,o.progress=Math.floor(o.completedFiles/o.totalFiles*100),o.files.filter(d=>d.status==="completed"||d.status==="error").length===o.totalFiles&&(o.completedFiles===o.totalFiles?o.status="completed":o.status="error"),a(),r=!0;break}}r?u():console.warn(`Download ID ${e} not found in queue.`)}
